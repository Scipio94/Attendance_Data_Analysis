~~~ SQL
/* CTE of Cleaned Data*/
WITH Clean AS (
/* Attendance Calculations - creation of true_absences column*/
SELECT s.employee_id, s.date,s.month,s.SchoolDays,s.department_name, s.absence, s.excused, s.unexcused, s.absence_type, (s.unexcused + s.absence) - s.excused AS true_absence, s.Day_type
FROM (
/* Data Cleanining and table creation with month, excused/unexcused absences, half/whole day */
SELECT employee_id, date, MONTH(date) AS Month,department_name, absence_type,hours, 
	/*CASE statement for the calculation for half and whole days aliased as Day_Type*/
	CASE 
	WHEN hours > 4 THEN 1
	ELSE 0.5 END AS Day_type,

	/*Count of Excused, Unexcused, and Absences based on IF THEN Formula*/
	COUNT(CASE WHEN Absence_Type IN ('Holiday','Personal','Vacation','Personal_(Longevity)', 'Professional_Development', 'Administrative_Leave','Bereavement', 'Religious_Observation', 'Sick', 'Covid_Sick') THEN 'Excused' END) AS Excused,
	COUNT (CASE WHEN Absence_Type = 'Unpaid_Time' THEN 'Unexcused' END) AS Unexcused,
	COUNT (CASE WHEN Absence_Type = 'Absent' THEN 'Absence' END) AS Absence,

	/* CASE Statement for the number of school days per month aliased as SchoolDays*/
	CASE 
	WHEN MONTH(date) = 8 THEN 8 
	WHEN MONTH(date) = 9 THEN 20
	WHEN MONTH(date) = 10 THEN 20
	WHEN MONTH(date) = 11 THEN 17 END SchoolDays

FROM dbo.Annonymized_Data_Clocking

/* Filter to exclude all Absence_Type 'Absent'*/ 

WHERE absence_type <> 'Absent'

GROUP BY Employee_id, date,department_name, absence_type, hours) AS s
GROUP BY s.employee_id, s.date,s.month,s.department_name, s.absence, s.excused, s.unexcused, s.absence_type,s.Day_type,s.SchoolDays)

/* PossibleDays = Difference of SchoolDays and sum of Excused days, DaysPresent =  PossibleDays minus the sum of unexcused days*/  

SELECT employee_id, department_name,month, SchoolDays, SUM(excused) AS ExcusedTotal, SUM(unexcused) AS UnexcusedTotal,(SchoolDays - SUM(excused)) - SUM(Unexcused) AS DaysPresent, SchoolDays - SUM(excused) AS PossibleDays, 
(((SchoolDays - SUM(excused)) - SUM(Unexcused)) * 1.0/  (SchoolDays - SUM(excused))  * 1.0) * 100 AS AttPercentage --DaysPresent/PossibleDays
FROM Clean
GROUP BY employee_id, month, SchoolDays, excused, Unexcused,Department_Name, Day_type
HAVING  (((SchoolDays - SUM(excused)) - SUM(Unexcused)) * 1.00/  (SchoolDays - SUM(excused))  * 1.00) * 100 > 0.00 AND SchoolDays - SUM(excused) > 0
~~~
